<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="nhitomi downloader client">
  <link rel="icon" type="image/png" href="https://github.com/fateloli/nhitomi/raw/master/nhitomi.png">

  <title>{title}</title>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body class="container" style="height: 100vh; display: flex; flex-direction: column;">

<header>
  <h1 class="mt-5">{title}</h1>
  <p class="lead">{subtitle}</p>

  <p><a id="galleryButton" target="_blank" role="button" class="btn btn-outline-info" style="display: none;"></a></p>
</header>

<div style="flex: 1; display: flex; flex-direction: row;">
  <img id="thumbnail" alt="thumbnail" class="img-thumbnail rounded"
       style="object-fit: contain; height: 96%; flex: 0; display: none;">
</div>

<p>
  <span class="spinner-border spinner-border-sm" role="status"></span>
  <strong id="status">Initializing...</strong>
</p>

<div class="progress" style="height: 2em; display: none;">
  <div id="progress" class="progress-bar progress-bar-striped" role="progressbar"></div>
</div>

<footer>
  <span class="text-muted" style="line-height: 3em;">Copyright (c) 2018-2019 phosphene47</span>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha256-CjSoeELFOcH0/uxWu6mC/Vlrc1AARqbm/jiiImDGV3s=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.0/jszip.js"
        integrity="sha256-EHgAIxZ/n1IaWzhk7MwPaOux4UOWSr3czJ4dEVimBvo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"
        integrity="sha256-AIk6chbus7IS5RVpqSNV1X7Qihbi1YC0lOLuUXQZ+mw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"
        integrity="sha256-FPJJt8nA+xL4RU6/gsriA8p8xAeLGatoyTjldvQKGdE=" crossorigin="anonymous"></script>

<script>
  "use strict";

  $(document).ready(function () {
    var $status = $("#status");
    var $progress = $("#progress");
    var $thumbnail = $("#thumbnail");

    function updateStatus(text, error) {
      $status.text(text);

      if (error) {
        $status.parent().addClass("text-danger");
      } else {
        $status.parent().removeClass("text-danger");
      }
    }

    function updateProgress(state, name) {
      var progress = Math.round(state / doujin.pages.length * 100) + "%";

      $progress
        .width(progress)
        .text(name ? progress + " â€” " + name : progress);

      $progress
        .parent()
        .fadeIn();
    }

    try {
      var doujin = {doujin};
      var proxies = {proxies};

      if (proxies.length === 0) {
        updateStatus("No proxies available!", true);
      } else {
        $thumbnail
          .attr("src", proxies[Math.floor(Math.random() * proxies.length)]
            + "/proxy/image?url=" + encodeURIComponent(doujin.pages[0].u)
            + "&token=" + encodeURIComponent("{token}"));

        $("#galleryButton")
          .attr("href", doujin.sourceUrl)
          .text(doujin.source.name + "/" + doujin.id)
          .fadeIn();

        $thumbnail.on('load', function () {
          $thumbnail.fadeIn();

          var zip = new JSZip();
          zip.file("_nhitomi.json", JSON.stringify(doujin, null, 2));

          function saveZip() {
            updateStatus("Saving...");
            $progress.addClass("bg-success");

            zip.generateAsync({
              type: "blob"
            }).then(function (content) {
              updateStatus("Saved!");
              $progress.fadeOut();

              saveAs(content, (doujin.originalName || doujin.prettyName) + ".zip");
            });
          }

          var images = doujin.pages.map(function (page, index) {
            function pad(num, size) {
              return ("00" + num).substr(-size);
            }

            return {
              url: proxies[index % proxies.length]
                + "/proxy/image?url=" + encodeURIComponent(page.u)
                + "&token=" + encodeURIComponent("{token}"),
              name: pad(index + 1, 3) + page.e
            };
          });
          images.reverse();

          var isError = false;
          var downloadedCount = 0;
          var concurrentDownloads = 0;

          function downloadNext() {
            while (concurrentDownloads < proxies.length && images.length !== 0) {
              concurrentDownloads++;

              (function (image) {
                JSZipUtils.getBinaryContent(image.url, function (error, data) {
                  if (isError)
                    return;
                  if (error) {
                    updateStatus(error, isError = true);
                    return;
                  }

                  zip.file(image.name, data, {
                    binary: true
                  });

                  updateProgress(++downloadedCount);

                  concurrentDownloads--;
                  downloadNext();

                  if (!isError && downloadedCount === doujin.pages.length)
                    saveZip();
                });
              })(images.pop());
            }
          }

          updateStatus("Downloading...");
          downloadNext();
        }).each(function () {
          if (this.complete)
            $(this).trigger('load');
        });
      }
    } catch (e) {
      updateStatus(e, true);
    }
  });
</script>

</body>

</html>
