<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="nhitomi downloader client">
  <link rel="icon" type="image/png" href="https://github.com/fateloli/nhitomi/raw/master/nhitomi.png">

  <title>{title}</title>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<body class="container" style="height: 100vh; display: flex; flex-direction: column;">

<header>
  <h1 class="mt-5">{title}</h1>
  <p class="lead">{subtitle}</p>

  <p><a id="galleryButton" target="_blank" role="button" class="btn btn-outline-info" style="display: none;"></a></p>
</header>

<div style="flex: 1; display: flex; flex-direction: row;">
  <img id="thumbnail" alt="thumbnail" class="img-thumbnail rounded"
       style="object-fit: contain; height: 96%; flex: 0; display: none;">
</div>

<p>
  <span class="spinner-border spinner-border-sm" role="status"></span>
  <strong id="status">Initializing...</strong>
</p>

<div class="progress" style="height: 2em; display: none;">
  <div id="progress" class="progress-bar progress-bar-striped" role="progressbar"></div>
</div>

<footer>
  <span class="text-muted" style="line-height: 3em;">nhitomi downloader by <a href="https://github.com/phosphene47"
                                                                              target="_blank">phosphene47</a></span>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.0/jszip.js"
        integrity="sha256-EHgAIxZ/n1IaWzhk7MwPaOux4UOWSr3czJ4dEVimBvo=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"
        integrity="sha256-AIk6chbus7IS5RVpqSNV1X7Qihbi1YC0lOLuUXQZ+mw=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.min.js"
        integrity="sha256-FPJJt8nA+xL4RU6/gsriA8p8xAeLGatoyTjldvQKGdE=" crossorigin="anonymous"></script>

<script>
  "use strict";

  $(document).ready(function () {
    var doujin = {doujin};
    var proxies = {proxies};

    var $status = $("#status");
    var $progress = $("#progress");
    var $thumbnail = $("#thumbnail");
    var $galleryButton = $("#galleryButton");

    function updateStatus(text, error) {
      $status.text(text);

      if (error) {
        $status.parent().addClass("text-danger");
        $progress.addClass("bg-danger");
      } else {
        $status.parent().removeClass("text-danger");
        $progress.removeClass("bg-danger");
      }
    }

    function updateProgress(state, name) {
      var progress = Math.round(state / doujin.pages.length * 100) + "%";

      $progress
        .width(progress)
        .text(name ? progress + " â€” " + name : progress);

      $progress
        .parent()
        .fadeIn();
    }

    var proxyIndex = Math.floor(Math.random() * proxies.length);

    function getProxiedImage(url) {
      return proxies[proxyIndex++ % proxies.length]
        + "/proxy/image?url=" + encodeURIComponent(url)
        + "&token=" + encodeURIComponent("{token}");
    }

    try {
      if (proxies.length === 0) {
        updateStatus("No proxies are available!", true);
      } else {
        $galleryButton
          .attr("href", doujin.sourceUrl)
          .text(doujin.source.name + "/" + doujin.id)
          .fadeIn();

        $thumbnail
          .on('load', function () {
            $thumbnail.fadeIn();

            var zip = new JSZip();
            zip.file("_nhitomi.json", JSON.stringify(doujin, null, 2));

            function saveZip() {
              updateStatus("Saving...");
              $progress.addClass("bg-warning");

              zip.generateAsync({
                type: "blob"
              }).then(function (content) {
                updateStatus("Saved!");
                $progress
                  .removeClass("bg-warning")
                  .addClass("bg-success");

                saveAs(content, (doujin.originalName || doujin.prettyName) + ".zip");
              });
            }

            var queue = doujin.pages.map(function (page) {
              return {
                name: ("00" + ((page.i || 0) + 1)).substr(3) + page.e,
                url: page.u
              };
            });
            queue.reverse();

            var running = true;
            var downloadedCount = 0;
            var concurrentDownloads = 0;

            function downloadNext() {
              while (concurrentDownloads < proxies.length && queue.length !== 0) {
                concurrentDownloads++;

                (function (image) {
                  var retryCount = 0;

                  function downloadCurrent() {
                    JSZipUtils.getBinaryContent(getProxiedImage(image.url), function (error, data) {
                      if (!running)
                        return;

                      if (error) {
                        if (retryCount++ === 20) {
                          queue.length = 0;
                          updateStatus("Could not download '" + image.url + "': " + error, !(running = false));
                        } else
                          setTimeout(downloadCurrent, 1000);

                        return;
                      }

                      zip.file(image.name, data, {
                        binary: true
                      });

                      concurrentDownloads--;
                      updateProgress(++downloadedCount, image.name);

                      if (downloadedCount === doujin.pages.length)
                        saveZip();
                      else
                        downloadNext();
                    });
                  }

                  downloadCurrent();
                })(queue.pop());
              }
            }

            updateStatus("Downloading...");
            downloadNext();
          })
          .on('error', function () {
            updateStatus("No proxies are available!", true);
          })
          .attr("src", getProxiedImage(doujin.pages[0].u))
          .each(function () {
            if (this.complete)
              $(this).trigger('load');
          });
      }
    } catch (e) {
      updateStatus(e, true);
    }
  });
</script>

</body>

</html>
